# ワークフローの表示名
name: CI

# 実行トリガー
on:
  #　　mainブランチへのプッシュ時に実行
  push:
    branches: [main]

  # mainブランチに対してプルリクエストの作成・更新時に実行
  pull_request:
    branches: [main]
  

# GitHub Actionsがリポジトリに対して行える権限の設定
permissions:
  contents: read

# 連続pushで古い実行をキャンセルする
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# 実行するジョブの定義
jobs:
  # ジョブのID(内部的な識別子)
  ci:

    # どの環境(OS)でジョブを実行するか
    # GitHubが提供する最新の仮想環境(Ubuntu)
    runs-on: ubuntu-latest

    # ジョブ内で実行するステップの定義
    steps:
      # チェックアウト
      # GitHub Actionsの実行環境にリポジトリをクローンする
      - name: Checkout
        uses: actions/checkout@v5

      # コマンドの実行
      - name: Hello
        run: |
          echo "GitHub Actions is running!"
          ls -la

      # Node.jsのセットアップ
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      
      # pnpmを使えるようにする（Actionで固定）
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      # バージョン確認
      - name: Show versions
        run: |
          node -v
          pnpm -v

      # pnpm の store パスを取得
      - name: Get pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      # pnpm store をキャッシュ
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
        
      # 依存関係のインストール
      # --frozen-lockfile: pnpm-lock.yamlの内容と一致していない場合、エラーにする
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # コードの静的解析(Lint)
      - name: Lint
        run: pnpm run lint
      
      # TypeScriptの型チェック(コンパイルなし)
      - name: Typecheck
        run: pnpm run typecheck

      # テストの実行
      - name: Test
        run: pnpm run test:ci

      # Next.jsのビルド(本番ビルドが通るかの確認)
      - name: Build
        run: pnpm run build